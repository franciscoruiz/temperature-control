<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Thermostat</title>
    <meta name="description" content="thermostat">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <meta http-equiv="cleartype" content="on">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
    <style type="text/css">
      /* Palette generated by Material Palette - materialpalette.com/amber/green */
      html {
        font-family: "Montserrat", sans-serif;
      }

      body {
        margin: 0;
      }

      body.on {
        background: #FFC107;
      }

      body.off {
        background: #727272;
      }

      .container {
        position: absolute;
        top: 30%;
        width: 100%;
      }
      .current-temperature, .controls {
        width: 100%;
        color: #FFECB3;
        display: flex;
        align-items: baseline;
        justify-content: center;
      }
      .current-temperature-main {
        font-size: 90px;
      }
      .current-temperature-decimal {
        font-size: 40px;
      }

      .controls {
        font-size: 40px;
        display: flex;
        align-items: baseline;
        justify-content: center;
      }
      .control {
        background: inherit;
        border: inherit;
        font: inherit;
        color: inherit;
        outline: inherit;
        padding: 0 20px 0 20px;
        margin: 0 10px 0 10px;
      }
      .control:active {
        color: #4CAF50;
      }

      .target-temperature-main {
        font-size: 40px;
      }
      .target-temperature-decimal {
        font-size: 20px;
      }

      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
      }

      .status {
        font-size: 40px;
      }
    </style>
  </head>
  <body class="default-primary-color">
    <div class="container">
      <div class="current-temperature">
        <span class="current-temperature-main">18</span>
        <span class="current-temperature-decimal">.0</span>
      </div>
      <div>
        <div class="controls">
          <button class="control control-left">-</button>
          <span class="target-temperature-main">20</span>
          <span class="target-temperature-decimal">.0</span>
          <button class="control control-right">+</button>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="current-temperature status">
        <button class="control">ON</button>
      </div>
    </div>

    <script src="/static/js/vendor/jquery-2.1.3.min.js"></script>
    <script>
      $(function () {
        "use strict";

        // Temperature values
        var current = 0.0;
        var target = 0.0;

        // Temperature value elements
        var $current = $(".current-temperature-main");
        var $currentDecimal = $(".current-temperature-decimal");

        var $target = $(".target-temperature-main");
        var $targetDecimal = $(".target-temperature-decimal");

        // Functions
        var getTemperature = function () {
          var req = $.get("/temperature/");
          req.success(function (data) {
            updateCurrentTemperatureElement(data.temperature);
            updateTargetTemperatureElement(data.target);
          });
        };

        var increaseTargetTemperature = function () {
          setTargetTemperature(target + 0.5);
        };

        var decreaseTargetTemperature = function () {
          setTargetTemperature(target - 0.5);
        };

        // Utilities
        var updateCurrentTemperatureElement = function (temp) {
          current = temp;
          updateTemperatureElement(temp, $current, $currentDecimal);
        };

        var updateTargetTemperatureElement = function (temp) {
          target = temp;
          updateTemperatureElement(temp, $target, $targetDecimal);
        };

        var updateTemperatureElement = function (temp, $natural, $decimal) {
          if (temp === null) {
            $natural.html("-");
            $decimal.html("");
          } else {
            var tempSplit = splitNumber(temp);
            $natural.html(tempSplit.natural);
            $decimal.html("." + tempSplit.decimal);
          }
        };

        var splitNumber = function (number) {
          var parts = number.toString().split(".");
          var natural = parts[0];
          var decimals = parts[1];
          var decimal = decimals ? decimals[0] : '0'
          return {natural: natural, decimal: decimal};
        };

        var targetTemperatureRequestLock = false;
        var setTargetTemperature = function (temperature) {
          updateTargetTemperatureElement(temperature);

          // Throttle requests
          if (targetTemperatureRequestLock) {
            return;
          }
          targetTemperatureRequestLock = true;
          setTimeout(sendTargetTemperatureRequest, 3000);
        };

        var sendTargetTemperatureRequest = function () {
          targetTemperatureRequestLock = false;
          $.ajax({
            type: "POST",
            url: "/temperature/",
            data: JSON.stringify({target: target}),
            contentType: "application/json"
          });
        };

        // Set-up
        getTemperature();
        setInterval(getTemperature, 50000);

        $(document).on("click", ".control-left", decreaseTargetTemperature);
        $(document).on("click", ".control-right", increaseTargetTemperature);


        // Status
        var $statusBtn = $(".status button");
        var isActive = null;

        var getStatus = function () {
          var req = $.get("/status/");
          req.success(function (data) {
            isActive = data.is_active;
            updateStatusElement(data.is_active);
          });
        };

        var updateStatusElement = function (isActive) {
          var label;
          var $body = $("body");
          var bodyClass;
          if (isActive) {
            $body.addClass("on").removeClass("off");
            label = "ON";

          } else {
            $body.addClass("off").removeClass("on");
            label = "OFF";
          }
          $statusBtn.html(label);
        };

        var toggleStatus = function () {
          isActive = !isActive;
          updateStatusElement(isActive);

          $.ajax({
            type: "POST",
            url: "/status/",
            data: JSON.stringify({is_active: isActive}),
            contentType: "application/json"
          });
        };

        getStatus();
        $statusBtn.on("click", toggleStatus);
      });
    </script>
  </body>
</html>
